import java.util.*;
import java.text.*;
import java.util.Date;
import java.util.TimerTask;
import java.text.SimpleDateFormat;
import java.util.Calendar;

public class TradeOperatorUnit extends DefinedData{// 意思決定   Trade情報により、買、維持、売の行動　また価格を決める

	String ProcessName = "TradeOperatorUnit";
	String SimulationMode;
	String TradeOperatorUnitState;
	String target;
	
	BoardInfo BoardInfo;
	UserProperty UserProperty;
	TradeStatics TradeStatics;
	
	LogUnit TradeOperateLog; // create statics log file
	LogUnit  ErrorLog;
	
	Date Now = new Date();
	
	
	TradeOperatorUnit(String target,BoardInfo BoardInfo, UserProperty UserProperty,TradeStatics TradeStatics,LogUnit ErrorLog,String SimulationMode,String LogPath, int Speed){
		TradeOperatorUnitState = "PREPARE";
		System.out.println( target+ "	"+ProcessName+"_"+SimulationMode+"_"+"Activating" );
		
		this.SimulationMode = SimulationMode;
		this.target = target;
		this.ErrorLog = ErrorLog;
		
		this.BoardInfo = BoardInfo;
		this.UserProperty = UserProperty;
		
		TradeOperateLog = new LogUnit(LogPath,this.target+"Trade",0); // create log file
		Now = new Date();
		
		TradeOperatorUnitState = "READY";
		System.out.println(target+ "	"+ProcessName+"_"+SimulationMode+"_"+"Ready" );	
	}
		
	public void run(){ 
		String SubProcessName = "Main_Loop ";
		System.out.println(target+ "	"+ProcessName+"_"+SimulationMode+"_"+"Standby" );
		String PreState = TradeOperatorUnitState;
		Calendar rightNow;
		
		while(!TradeOperatorUnitState.equals("END")){
			switch(TradeOperatorUnitState){
			
			case "READY":
				
				break;	
			case "START":	
				if (PreState.equals("READY")){
					//初回のプロセスの起動に使う
					PreState = TradeOperatorUnitState;
					System.out.println(target+ "	"+ProcessName+"_"+SimulationMode+"_"+"Start");
				}	
				
				SimpleDateFormat D = new SimpleDateFormat("HH:mm:ss.SSS");
		    	rightNow = Calendar.getInstance();
				Now = rightNow.getTime();
				
				try{
					Thread.sleep(1000);
				}catch (InterruptedException e){
				}	
				
				if(UserProperty.UserAction.Action.equals("BUY")){// 購買行動
					synchronized (UserProperty.UserPropertyLock){
						UserProperty.cash = UserProperty.cash - UserProperty.UserAction.Price*UserProperty.UserAction.Stack_Num;
						UserProperty.Holded = "HOLDED";
						UserProperty.UserAction.Action = "NONE";
						
						String temp  = BoardInfo.Date + "	" + D.format(Now) + "	BUY"+"	"+UserProperty.UserAction.Price+"	" + 
										UserProperty.cash+"	" + BoardInfo.MarketStatus+"	" + BoardInfo.StockStatus +"\r\n";	
						TradeOperateLog.FileWrite(temp);
						System.out.println("Buy Price="+UserProperty.UserAction.Price + " Cash = " +UserProperty.cash);
						
					}
				} 
				else if(UserProperty.UserAction.Action.equals("SELL")){// 購買行動
					synchronized (UserProperty.UserPropertyLock){
						UserProperty.cash = UserProperty.cash + UserProperty.UserAction.Price*UserProperty.UserAction.Stack_Num;
						UserProperty.UserAction.Action = "NONE";
						UserProperty.Holded = "NONE";
						String temp  = BoardInfo.Date + "	" + D.format(Now) + "	SELL"+"	"+UserProperty.UserAction.Price+"	" + 
										UserProperty.cash +"	" + BoardInfo.MarketStatus+"	" + BoardInfo.StockStatus+"\r\n";						
						TradeOperateLog.FileWrite(temp);
						System.out.println("Sell Price="+UserProperty.UserAction.Price + " Cash = " +UserProperty.cash);
					}
				}
			
				
				System.out.println( target+ "	"+ProcessName+"_"+SimulationMode+"_"+"Start");
				break;
			case "PAUSE":
				//System.out.println( "TradeOperatorUnit PAUSE");
				break;
			case "FINISHING":
				//---------------気配板プロセスの完了待つ-----------------------------	
				/*while(!XXXX.equals("END")){
					try{
						Thread.sleep(10);
					}catch (InterruptedException e){
					}
				}*/
				//System.out.println( "TradeOperatorUnit FINISH");
				TradeOperatorUnitState = "END";
				break;
			case "ERROR":	
				//System.out.println( "TradeOperatorUnit ERROR");
				break;
				
			}	
			try{
				Thread.sleep(500);
			}catch (InterruptedException e){
			}	
		}		
		System.out.println(target+ "	"+ProcessName+"_"+SimulationMode+"_"+"End" );
		//start any web access process 
	}
	void ErrorLogWrite(String ProccessName, String SubProcessName , String Error){
		Calendar rightNow;
		Date Now = new Date();
    	SimpleDateFormat D = new SimpleDateFormat("yyyy/MM/dd	HH:mm:ss.SSS");
    	rightNow = Calendar.getInstance();
		Now = rightNow.getTime();
		
		String temp =  D.format(Now) + "	" + ProccessName + "	" + SubProcessName + "	" +Error +"\r\n";
		ErrorLog.FileWrite(temp);
		
	}
}